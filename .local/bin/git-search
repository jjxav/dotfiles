#!/usr/bin/env bash

IFS=$'\n'
declare -a git_dirs=()
declare -a directories=()
declare -a listing=()

function list_dir {
	printf '%s\n' "$@"
}

[[ -w /srv ]] && directories+=("/srv")

if [[ -w ~/project ]]; then
	directories+=("$HOME/project")
	listing+=("$HOME/project")
fi

if [[ -w ~/school ]]; then
	directories+=("$HOME/school")
	listing=("$HOME/school")
fi

if [[ -w /srv/Websites/ ]]; then
	directories+=("/srv/Websites/")
	listing+=("/srv/Websites/")
fi

[[ -w $HOME ]] && directories+=("$HOME")

if [[ -d $1 ]]; then
	directories+=($1)
	listing+=($1)
fi

tmux has-session > /dev/null 2>&1 && git_dirs+=($(tmux list-sessions -F "#{session_path}" 2> /dev/null))

for d in "${directories[@]}"; do
	git_dirs+=($(find "$d" -maxdepth 2 -type d \( -name '.*' -o -name 'gits' -o -path '*/vendor/*' -o -path '*/node_modules/*' \) -prune -iname '.git' -exec dirname {} \; | xargs -n 1 echo))
done

for d in "${listing[@]}"; do
	git_dirs+=($(find "$d" -maxdepth 1 -exec realpath -L {} \;))
done


[[ -z $git_dirs ]] && exit 1

declare -a found_dirs=($(list_dir "${git_dirs[@]}" | xargs -d'\n' -n 1 | sort -n | uniq))

dir=$(list_dir "${found_dirs[@]}" | fzf --list-label="Directories & Tmux sessions" --input-label="Search your directories" --preview-label="Directories Listing" --preview="eza --color always -lahF --icons --no-permissions --no-user --no-time --group-directories-first {}")

[[ ! $dir ]] && exit 1

echo $dir

